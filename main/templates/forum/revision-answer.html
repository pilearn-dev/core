{% extends "layout.html" %}
{% macro generate_diff_line(line) %}
{%- if line[0] == 1 -%}<div class="diff-added">{%- elif line[0] == 0 -%}<div class="diff-neutral">{%- elif line[0] == -1 -%}<div class="diff-removed">{%- endif -%}
{% endmacro %}
{% block body %}

<nav class="coursenav">
  {% if forum.id == 0 %}
      <h2>globales Forum</h2>
      <p>für alle Fragen zu &pi;-Learn selber und für Fehlermeldungen oder Verbesserungsideen</p>
  {% else %}
    {% set topic = forum.getTopic() %}
    <h2>{{ forum.getTitle() }} <i><a href="/topic/{{ topic.id }}/{{ topic.getName() }}/info" class="topic">{{ topic.getTitle() }}</a></i></h2>
    {{ forum.getByLine()|markdown }}
    <ul>
      <li><a href="/c/{{ forum.id }}/info">Informationen</a></li>
      <li><a href="/course/{{ forum.id }}/{{ forum.getLabel() }}/start">Kursinhalte</a></li>
      <li class="active"><a href="/f/{{ forum.id }}">Kursforum</a></li>
    </ul>
  {% endif %}
</nav>

<h2>Versionen von {% if post.isDeleted() %}<span class="deleted-line">{% endif %}<a href="/f/{{ forum.id }}/{{ article.id }}#answer-{{ post.id }}">{{ article.getTitle() }}</a> (Antwort){% if post.isDeleted() %}</span>{% endif %}</h2>
{% if user.isDev() %}{% if not request.values.get("show-revision-ids", "0") == "1" %}
<p><a href="?show-revision-ids=1">Versions-IDs anzeigen</a></p>
{% else %}
<p><a href="?show-revision-ids=0">Versions-IDs ausblenden</a></p>
{% endif %}{% endif %}
<div class="revision-list">
  {% for rev in post.getAllRevisions() %}
    {% if rev.type == "edit" %}
      <div class="revision">
        <h3 class="primary">Version {{ rev.revid }} / {{ post.getRevisionCount() }} von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a></h3>
        {% if not post.isDestroyed() or user.isMod() %}
        <div class="no-p comment">
          <p><b>Kommentar:</b></p>
          {{ rev.comment|markdown }}
        </div>
        {% if rev.revid == 1 %}
          <div class="title">{{ rev.title }}</div>
          <pre class="content">{{ rev.content }}</pre>
        {% else %}
          {% if rev.title != post.getRevision(rev.revid-1).title %}
            <div class="title"><span class="diff-removed">{{ post.getRevision(rev.revid-1).title }}</span><span class="diff-added">{{ rev.title }}</span></div>
          {% else %}
            <div class="title">{{ rev.title }}</div>
          {% endif %}
          {% set diff = generate_diff(post.getRevision(rev.revid-1).content, rev.content) %}
          <pre class="content">
          {%- for line in diff -%}{{ generate_diff_line(line) }}{{ line[1] }}</div>{%- endfor -%}
        </pre>
        {% endif %}
        <p class="tiny action-bar">
          {% if (not post.isFrozen() or user.isMod()) and (user.may("forum_reviewEdits") or user.id == post.getAuthor().id) and rev.revid != post.getRevisionCount() %}
          <a href="/forum/{{ forum.id }}/{{ forum.getDetail("label") }}/answer/{{ post.id }}/rollback/{{ rev.id }}">Wiederherstellen</a>
          {% endif %}
        </p>
        {% else %}
        <b>Beitrag wurde zerstört, Version wird nicht angezeigt.</b>
        {% endif %}
      {% elif rev.type == "static" %}
          <div class="revision">
            <h3 class="primary">Version {{ rev.revid }} / {{ post.getRevisionCount() }} von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a></h3>
            {% if not post.isDestroyed() or user.isMod() %}
            <div class="no-p comment">
              <p><b>Kommentar:</b></p>
              {{ rev.comment|markdown }}
            </div>
            {% if rev.revid == 1 %}
              <div class="title">{{ rev.title }}</div>
              <pre class="content">{{ rev.content }}</pre>
            {% else %}
              {% if rev.title != post.getRevision(rev.revid-1).title %}
                <div class="title"><span class="diff-removed">{{ post.getRevision(rev.revid-1).title }}</span><span class="diff-added">{{ rev.title }}</span></div>
              {% else %}
                <div class="title">{{ rev.title }}</div>
              {% endif %}
              {% set diff = generate_diff(post.getRevision(rev.revid-1).content, rev.content) %}
              <pre class="content">
              {%- for line in diff -%}{{ generate_diff_line(line) }}{{ line[1] }}</div>{%- endfor -%}
            </pre>
            {% endif %}
            {% else %}
            <b>Beitrag wurde zerstört, Version wird nicht angezeigt.</b>
            {% endif %}
    {% elif rev.type == "notice" %}
      {% if rev.comment != "" %}
        <div class="revision no-edit">
          <h3 class="primary">Moderatorennachricht von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> gesetzt</h3>
          <div class="no-p action-forbidden">
            {{ rev.comment|markdown }}
          </div>
      {% else %}
        <div class="revision no-edit no-padbot">
          <h3 class="primary">Moderatorennachricht von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> entfernt</h3>
      {% endif %}
    {% elif rev.type == "deleted" %}
      <div class="revision no-edit no-padbot">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> gelöscht</h3>
    {% elif rev.type == "undeleted" %}
      <div class="revision no-edit no-padbot">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> un-gelöscht</h3>
    {% elif rev.type == "frozen" %}
      <div class="revision no-edit">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> eingefroren</h3>
        <div class="action-forbidden red-style">
          <h4>Grund:</h4>
          {% if rev.comment != "" %}
            {{ rev.comment|markdown }}
          {% endif %}
        </div>
    {% elif rev.type == "unfrozen" %}
      <div class="revision no-edit no-padbot">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> aufgetaut</h3>
    {% elif rev.type == "transferred" %}
      <div class="revision mark no-padbot">
        {% set new_user = user.from_id(rev.comment) %}
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a>
 an <a href="/u/{{ new_user.id }}">{{ new_user.getHTMLName()|safe }}</a> übergeben</h3>
    {% elif rev.type == "anonymized" %}
      <div class="revision mark no-padbot">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> in Wiki umgewandelt</h3>
    {% elif rev.type == "destroyed" %}
      <div class="revision mark no-padbot">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> zerstört</h3>
    {% elif rev.type == "restored" %}
      <div class="revision mark no-padbot">
        <h3 class="primary">Beitrag von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a> wiederhergestellt</h3>
    {% elif rev.type == "comment" %}
      <div class="revision no-edit no-padbot">
        {{ rev.comment|markdown }}
        <hr>
        <p><i>von <a href="/u/{{ rev.editor.id }}">{{ rev.editor.getHTMLName()|safe }}</a></i></p>
    {% endif %}
    {% if user.isDev() and request.values.get("show-revision-ids", "0") == "1" %}
      <p class="tiny">ID: <code>{{ rev.id }}</code></p>
    {% endif %}
    </div>
  {% endfor %}
</div>
{% endblock %}
