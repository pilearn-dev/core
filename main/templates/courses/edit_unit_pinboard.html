{% extends "layout.html" %}
{% block body %}
  <link rel="stylesheet" href="/static/ps/polyskript.css">
  <nav class="coursenav">
    {% set topic = course.getTopic() %}
    <h2>{{ course.getTitle() }} <i><a href="/topic/{{ topic.id }}/{{ topic.getName() }}/info" class="topic">{{ topic.getTitle() }}</a></i></h2>
    {{ course.getByLine()|markdown }}
    <ul>
      <li><a href="/course/{{ course.id }}/{{ course.getLabel() }}/details">Informationen</a></li>
      <li class="active"><a href="#!">Kursinhalte</a></li>
      <li><a href="/forum/{{ course.id }}/{{ course.getLabel() }}/list">Kursforum</a></li>
    </ul>
  </nav>
 <div class="split-screen">
   <aside>
     <h3>Alle Inhalte</h3>
     <ol>
       {% for element in course.getMenu() %}
        {% if element.availible %}
        {% if element.id == data.id %}
        <li><a href="/c/{{ course.id }}/u/{{ element.id }}/edit" class="current">{{ element.title }}</a>
        {% else %}
        <li><a href="/c/{{ course.id }}/u/{{ element.id }}/edit">{{ element.title }}</a>
        {% endif %}
        {% else %}
        {% if element.id == data.id %}
        <li><a style="opacity: 0.7" href="/c/{{ course.id }}/u/{{ element.id }}/edit" class="current">{{ element.title }}</a>
        {% else %}
        <li><a style="opacity: 0.7" href="/c/{{ course.id }}/u/{{ element.id }}/edit">{{ element.title }}</a>
        {% endif %}
        {% endif %}
          {% if element.children %}
          <ol>
            {% for child in element.children %}
             {% if child.availible %}
             {% if child.id == data.id %}
             <li><a href="/c/{{ course.id }}/u/{{ child.id }}/edit" class="current">{{ child.title }}</a>
             {% else %}
             <li><a href="/c/{{ course.id }}/u/{{ child.id }}/edit">{{ child.title }}</a>
             {% endif %}
             {% else %}
             {% if child.id == data.id %}
             <li><a style="opacity: 0.7" href="/c/{{ course.id }}/u/{{ child.id }}/edit" class="current">{{ child.title }}</a>
             {% else %}
             <li><a style="opacity: 0.7" href="/c/{{ course.id }}/u/{{ child.id }}/edit">{{ child.title }}</a>
             {% endif %}
             {% endif %}
            {% endfor %}
          </ol>
          {% endif %}
        </li>
       {% endfor %}
     </ol>
   </aside>
   <main>
       <button class="primary-btn" onclick="save()">Speichern</button> <a href="/c/{{ course.id }}/u/{{ data.id }}">Abbrechen</a>
       <hr>
      <h1><input data-before="Info: " class="inline" id="title" value="{{ data.getTitle() }}"></h1>
      {% if data.isDisabled() %}
      <label for="availible"><input type="checkbox" id="availible"> Diese Seite darf besucht werden.</label>
      {% else %}
      <label for="availible"><input type="checkbox" id="availible" checked> Diese Seite darf besucht werden.</label>
      {% endif %}
      <label for="c_embed">ID/Link des Beitrags, der eingebettet werden soll:</label>
      <input type="text" id="c_embed" value="{{ data.getJSON() }}">
      <script>
       ps = new Polyskript({{ data.getJSON()|tojson }});
       ps.show()

       function save() {
         x = document.getElementById("c_embed").value.match(/^https?:\/\/[a-z0-9A-Z.]+?\/forum\/([0-9]+?)\/[a-z0-9-]+?\/article\/([0-9]+?)\/[a-z0-9-]+?$/);
         if(!Number.isNaN(Number(document.getElementById("c_embed").value))) {
          x = [0,0,document.getElementById("c_embed").value];
         } else if(!x || x[1] != {{ course.id }}) {
           alert("Dieser Link ist ungünstig. Der Forenbeitrag muss sich im Kursforum für diesen Kurs befinden.");
           return;
         }
         $post("c/{{ course.id }}/u/{{ data.id }}/edit", {
           "title": document.getElementById("title").value,
           "availible": document.getElementById("availible").checked,
           "content": x[2]
         }, function () {
           window.location.reload();
         })
       }
     </script>
   </main>
 </div>
{% endblock %}
